<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <style>
    ul,
    li {
      list-style: none;
    }

    #root {
      display: inherit;
      width: 100%;
      height: 100vh;
      grid-template-rows: 3fr 1fr;
      position: relative;
      margin-top: 2em;
    }

    .dropzone {
      --dimension: 66vh;
      /* display: none; */
      display: grid;
      grid-template-rows: 1fr 1fr 1fr;
      align-items: center;
      justify-content: center;
      /* border: 4px dashed #4466ee82; */
      font-family: "Quicksand", sans-serif;
      width: var(--dimension);
      height: var(--dimension);
      margin: 0 auto;
      padding: 0.9em;
      box-sizing: border-box;
      position: relative;
    }

    .dropzone.showborder {
      /* display: grid; */
      position: relative;
      border: 4px dashed #4466EE;
      grid-template-rows: 1fr;
      background-color: rgba(227, 255, 193, 0.15);
    }

    .dropzone.hideui {
      display: none;
    }

    .dropzone>span {
      text-transform: uppercase;
      text-align: center;
    }

    .dropzone .addbutton {
      align-self: flex-end;
      justify-self: center;
      display: inline-block;
      width: max-content;
      font-size: 1.8em;
      padding: 0.4em 2.1em 0.4em 0.8em;
      border-radius: 10px;
      background-color: #6495ed;
      color: #ffffffad;
      box-shadow: 0 0 5px #6495ed;
      cursor: pointer;
      position: relative;
    }


    .showborder .addbutton,
    .hideui .addbutton {
      display: none;
    }

    .addbutton>svg {
      width: 50px;
      height: 50px;
      font-size: 2.5rem;
      position: absolute;
      top: 6.7px;
      left: 155px;
    }

    .dropzone .or {
      align-self: center;
      justify-self: center;
      font-size: 2em;
      font-weight: bolder;
      color: #9e9e9ef5;
      pointer-events: none;
    }



    .showborder .or,
    .hideui .or {
      display: none;
    }

    .dropzone .textui {
      align-self: start;
      justify-self: center;
      width: 80%;
      font-size: 3em;
      font-weight: bolder;
      color: #6495ed;
      pointer-events: none;
    }

    .showborder .textui {
      align-self: center;
    }

    .hideui .textui {
      display: none;
    }

    /* .dropzone.showborder>* {
      display: none;
      visibility: hidden;
      pointer-events: none;
    } */

    .file-holder {
      display: none;
    }

    .file {
      position: relative;
      padding: .5em 0 .5em 3em;
      margin-bottom: 1em;
      box-shadow: 0 0 5px #7a7676;
      border-radius: 5px;
      font-family: sans-serif;
    }

    .file-holder .fileStats {
      font-size: 15px;
      margin-right: 23px;
    }

    .fileStats .filename {
      font-weight: bold;
      margin-bottom: .2em;
    }

    .fileStats .filesize {
      font-weight: lighter;
      color: darkgrey;
    }

    .file-holder .progressbar-outline {
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background-color: #9e9e9e40;
      margin-top: .5em;
    }

    .file-holder .progressbar-inner {
      width: 0%;
      height: 100%;
      border-radius: 5px;
      background-color: cornflowerblue;
      transition: width 1s ease-out;

    }

    .showflex {
      display: flex;
      flex-direction: column;
    }

    .showflex .file {
      margin-bottom: 1em;
    }

    .deleteIcon {
      font-weight: bold;
      position: absolute;
      right: 15px;
      top: 5px;
      cursor: pointer;
      color: #0000007a;
    }

    .deleteIcon:hover {
      color: #000000bf;
    }

    .fileIcon {
      position: absolute;
      left: 11px;
      top: 20px;
      color: #000000ad;
    }

    .checkIcon {
      font-size: 0.8em;
    }

    .checkIcon svg {
      position: relative;
      top: 8px;
    }

    .buttons {
      /* display: flex; */
      display: none;
      justify-content: flex-end;
      font-family: sans-serif;
      font-weight: bold;
    }

    .buttons .addbutton2 {
      display: flex;
      align-items: center;
      border: 2px solid black;
      padding: 0.6em 1.6em;
      border-radius: 5px;
      cursor: pointer;
    }

    .addbutton2>svg {
      margin-left: 5px;
    }

    .buttons .submit {
      display: flex;
      align-items: center;
      background-color: #4466EE;
      padding: 0.6em 1.6em;
      border-radius: 5px;
      box-shadow: 0 0 5px #4466eeb8;
      cursor: pointer;
      color: #ffffffad;
      margin-left: 3em;
    }

    .buttons.show {
      display: flex;
    }

    svg {
      width: 25px;
      height: 25px;
      font-size: 1.7em;
      pointer-events: none;
    }

    .fileError {
      background-color: #ff00003b;
    }

    .fileError .filesize {
      color: #715555;
    }

    .errorDetails {
      margin-right: 23px;
      margin-top: 26px;
      line-height: 0.7;
    }

    .no-pointer>div,
    .no-pointer>span {
      pointer-events: none;
      cursor: grabbing;
    }
  </style>
</head>

<body>
  <div>
    <!-- File svg Icon -->
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="file-icon-solid" viewBox="0 0 384 512" fill="currentColor" width="1em" height="1em">
        <path
          d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z" />
      </symbol>
    </svg>

    <!-- Close Icon -->
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="close-icon-solid" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em">
        <g>
          <path fill="none" d="M0 0h24v24H0z" />
          <path
            d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" />
        </g>
      </symbol>
    </svg>
    <!-- Check Icon -->
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 48 48">
      <symbol id="check-icon-colored" viewBox="0 0 48 48" width="1em" height="1em">
        <polygon fill="#43A047" points="40.6,12.1 17,35.7 7.4,26.1 4.6,29 17,41.3 43.4,14.9" />
      </symbol>
    </svg>

    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="add-icon-regular" viewBox="0 0 24 24" width="1em" height="1em" fill="currentColor">
        <path
          d="M20,2H8C6.897,2,6,2.897,6,4v12c0,1.103,0.897,2,2,2h12c1.103,0,2-0.897,2-2V4C22,2.897,21.103,2,20,2z M8,16V4h12 l0.002,12H8z" />
        <path
          d="M4 8H2v12c0 1.103.897 2 2 2h12v-2H4V8zM15 6L13 6 13 9 10 9 10 11 13 11 13 14 15 14 15 11 18 11 18 9 15 9z" />
      </symbol>
    </svg>
  </div>


  <h2>Try to drop a files</h2>
  <p>It's only .jpg, jpeg and .wav file can be drop</p>

  <div>Lesson Number: <b>4123</b></div>
  <div><b>Enjoyable Characters with Joy, Episode 2</b></div>

  <div id="root">

    <div class="dropzone">
      <input type="file" style="display: none;" multiple id="fileInput">
      <span class="addbutton">ADD FILE
        <svg>
          <use href="#add-icon-regular" />
        </svg>
      </span>
      <span class="or">OR</span>
      <span class="textui">DROP TO ADD FILE</span>
    </div>
    <div class="file-holder"></div>
    <div class="buttons">
      <span class="addbutton2">ADD MORE FILES
        <svg>
          <use href="#add-icon-regular" />
        </svg>
      </span>
      <span class="submit">Submit</span>
    </div>

  </div>

  <script>

    // variable declaration
    const allowedFileExt = ['jpg', 'jpeg', 'wav'];
    const acceptedMimeType = ['image/jpeg', 'audio/wav'];

    const fileData = new FormData();
    const root = document.querySelector('#root')
    const dropzone = document.querySelector('.dropzone');
    const fileHolder = document.querySelector('.file-holder');
    const buttons = document.querySelector('.buttons');
    const submit = document.querySelector('.submit');
    const addButton = document.querySelector('.addbutton');
    const addButton2 = document.querySelector('.addbutton2');
    const fileInput = document.querySelector('#fileInput');

    // event listeners
    root.addEventListener('dragover', dragOverRoot, true);
    root.addEventListener('drop', dropRoot);
    root.addEventListener('dragleave', dragLeaveRoot);
    // dropzone.addEventListener('drop', dropzoneDrop);
    dropzone.addEventListener('dragover', dropzoneDragOver, true);
    submit.addEventListener('click', submitHandler);
    fileInput.setAttribute('accept', acceptedMimeType.join())
    fileInput.addEventListener('change', fileInputChange)
    addButton.addEventListener('click', () => fileInput.click())
    addButton2.addEventListener('click', () => fileInput.click())


    // functions

    function fileInputChange(e) {
      console.log('files was added');
      appendFormData(e.currentTarget.files);
      hideDropZoneBorder()
    }


    fileData.__proto__.fileNameConvention = function () {

      const lessonNum = 4123 /* hardcoded for now */
      const nameLenRage = [4, 5];
      const group4Names = ['sp', 'tp', 'sl', 'tl']
      const nameConvetions = 'file does not follow naming convention';
      const Group1Convention = `Group1 name must be the ${lessonNum}`;
      const Group2Convention = 'Group2 name should be number 0 - 9 or 4 digit numeric character'
      const Group4Convention = `Group4 name must be either of the following ${group4Names.join(', ')}`

      const fileError = {};
      for (const entry of this.entries()) {
        const splitFilename = entry[1].name.split('.');
        const key = entry[0]
        const error = []
        let errorCount = 0;
        if (splitFilename.length < nameLenRage[0] || splitFilename.length > nameLenRage[1]) {
          error[errorCount] = nameConvetions
          errorCount++;
        } else {
          // checking Group1
          if (!parseInt(splitFilename[0]) || parseInt(splitFilename[0]) !== lessonNum) {
            error[errorCount] = Group1Convention
            errorCount++;
          }
          // checking Group2
          if (!parseInt(splitFilename[1])) {
            error[errorCount] = Group2Convention
            errorCount++;
          } else if (splitFilename[1].toString().length === 4) {
            // no error if character is equal to 4
          } else if (splitFilename[1] > 9 || splitFilename[1] < 0) {
            error[errorCount] = Group2Convention
            errorCount++;
          }
          // checking Group4
          if (splitFilename.length === 5) {
            if (!group4Names.find(name => name === splitFilename[3])) {
              error[errorCount] = Group4Convention
              errorCount++;
            }
          }
        }

        if (errorCount) {
          fileError[key] = error
        }
      }
      let counter = 1
      for (const error in fileError) {
        const element = document.querySelector(`#${error}`)
        setTimeout(() => {
          if (!element.querySelector('.errorDetails')) {
            const errorDetails = document.createElement('div');
            const errorList = fileError[error].map(err => {
              return `<li>${err}</li>`
            })
            errorDetails.className = "errorDetails";
            errorDetails.innerHTML = `<b>Please fix the following Issue:</b><ul>${errorList}</ul>`;
            element.classList.add('fileError')
            element.appendChild(errorDetails)
          }
        }, (100 * counter) * 2 + 1000);
        counter++
      }
    }

    function showSubmitButton() {
      let counter = 0
      for (const file of fileData.entries()) {
        counter++
      }
      if (counter) {
        buttons.classList.add('show')
      } else {
        buttons.classList.remove('show')
      }
      return counter
    }

    // This function manipulates DOM
    function renderFileStats(fileKey, stats, i) {
      const file = document.createElement('div');
      const fileStats = document.createElement('div');
      const filename = document.createElement('div');
      const filesize = document.createElement('div');
      const deleteFile = document.createElement('span');
      const fileIcon = document.createElement('span');

      file.className = 'file'
      file.id = fileKey;
      fileIcon.className = 'fileIcon';
      fileIcon.innerHTML = `<svg><use href="#file-icon-solid" /></svg>`;
      deleteFile.className = 'deleteIcon';
      deleteFile.innerHTML = `<svg><use href="#close-icon-solid" /></svg>`;
      deleteFile.addEventListener('click', deleteFileHandler)

      function deleteFileHandler(e) {
        const element = e.currentTarget.parentElement;
        fileHolder.removeChild(element);
        const key = element.id.toLowerCase();
        fileData.delete(key);
        showSubmitButton()
      }

      fileStats.className = 'fileStats';
      filename.className = 'filename';
      filesize.className = 'filesize';
      filename.innerText = stats.name

      function calcFileSize() {
        let size = stats.size
        size = Math.round(size / 1000)

        if (size.toString().length > 3) {
          size = Math.round(size / 1000)
          return `${size} MB`;
        }

        return `${size} KB`;
      }

      filesize.innerHTML = `${calcFileSize()} <span class="checkIcon"><svg><use href="#check-icon-colored" /></svg></span>`;

      const outline = document.createElement('div');
      const inner = document.createElement('div');

      outline.className = 'progressbar-outline'
      inner.className = 'progressbar-inner'
      setTimeout(() => inner.style.width = '100%', 100 * i)

      outline.appendChild(inner)
      fileStats.appendChild(filename)
      fileStats.appendChild(filesize)
      fileStats.appendChild(outline)

      file.appendChild(fileIcon);
      file.appendChild(fileStats);
      fileHolder.appendChild(file)
      setTimeout(() => {
        fileStats.removeChild(outline);
        file.appendChild(deleteFile);
      }, (100 * i) * 2 + 1000);
    }

    // This functions holds the lists of files that are being dropped,
    // Invalid files are disregarded and will not be included in the lists,
    function appendFormData(param) {
      const files = param
      let counter = 0

      const validFile = new FormData();
      let index = (() => {
        let counter = 0
        for (const file of fileData.keys()) {
          counter++
        }
        return counter;
      })();

      for (let i = 0; i < files.length; i++) {
        const fileName = files[i].name
        const splitName = fileName.split('.');
        const fileExt = splitName[splitName.length - 1].toLowerCase()
        const found = allowedFileExt.find(ext => ext === fileExt);
        if (found) {
          fileData.append(`file${index}`, files[i]);
          validFile.append(`file${index}`, files[i]);
          index++
          counter++
        } else {
          console.log(`${fileName} is not a valid file`)
        }
      }
      if (counter) {
        showFlex(true);
        let i = 1
        for (const file of validFile.entries()) {
          renderFileStats(file[0], file[1], i);
          i++
        }
        fileData.fileNameConvention()
      }
      showSubmitButton();
    }


    function hideDropZoneBorder() {
      dropzone.classList.remove('showborder');
      root.style.removeProperty('display');

      let count = 0
      for (const file of fileData.entries()) {
        count++
      }
      if (count) {
        fileHolder.classList.add('showflex');
        buttons.classList.add('show')
        hideUI(true)
      }
    }

    function showDropZoneBorder() {
      fileHolder.classList.remove('showflex');
      dropzone.classList.add('showborder');
      root.style.display = 'grid'
      buttons.classList.remove('show')
      hideUI(false)
    }

    function hideUI(boolean = false) {
      if (boolean) {
        dropzone.classList.add('hideui')
      } else {
        dropzone.classList.remove('hideui')
      }
    }

    function showFlex() {
      fileHolder.classList.add('showflex');
    }

    function hideFlex() {
      fileHolder.classList.remove('showflex');
    }

    function disablePointer(element) {
      element.classList.add('no-pointer')
    }

    function enablePointer(element) {
      element.classList.remove('no-pointer');
    }

    function dragOverRoot(e) {
      e.preventDefault();
      e.stopPropagation();
      showDropZoneBorder();
      buttons.classList.remove('show');
      disablePointer(e.currentTarget)
    }

    function dragLeaveRoot(e) {
      const element = e.currentTarget
      hideDropZoneBorder();
      showSubmitButton();
      disablePointer(element)
      if (e.target.tagName.toLowerCase() === 'body') {
        enablePointer(element)
      }
    }

    function dropRoot(e) {
      e.preventDefault();
      console.log('files was dropped');
      appendFormData(e.dataTransfer.files);
      hideDropZoneBorder()
      enablePointer(e.currentTarget)
    }

    function dropzoneDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('dragged on the dropzone');
      const element = document.querySelector('#root')
      hideDropZoneBorder()
      // disablePointer(element)
    }

    function submitHandler(e) {
      let counter = 0
      for (const file of fileData.keys()) counter++
      if (counter) {
        fetch('/submitter/draganddrop', {
          method: 'post',
          body: fileData
        })
          .then((msg) => console.log(msg))
          .catch((err) => console.log(err))
      } else {
        console.log('no files uploaded');
      }
    }
  </script>

</body>