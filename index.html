<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <style>
    #root {
      display: inherit;
      width: 100%;
      height: 100vh;
      /* border: 1px solid red; */
      grid-template-rows: 3fr 1fr;
    }

    .dropzone {
      display: none;
      align-items: center;
      justify-content: center;
      /* justify-self: center; */
      /* align-self: center; */
      border: 4px dashed #4466EE;
      font-family: "Quicksand", sans-serif;
      font-size: 3em;
      /* height: 80%; */
      /* width: 80%; */
      /* width: 100%; */
      margin: 0 5em;
      user-select: none;
    }

    .drop-zone.dragOver {
      border-style: solid;
    }

    .file-holder {
      display: none;
    }

    .file {
      position: relative;
      padding: .5em 0 .5em 3em;
      margin-bottom: 1em;
      box-shadow: 0 0 5px #7a7676;
      border-radius: 5px;
    }

    .file-holder .fileStats {
      font-size: 15px;
      font-family: sans-serif;
    }

    .fileStats .filename {
      font-weight: bold;
      margin-bottom: .2em;
    }

    .fileStats .filesize {
      font-weight: lighter;
      color: darkgrey;
    }

    .file-holder .progressbar-outline {
      width: 90%;
      height: 10px;
      border-radius: 5px;
      background-color: #9e9e9e40;
      margin-top: .5em;
    }

    .file-holder .progressbar-inner {
      width: 0%;
      height: 100%;
      border-radius: 5px;
      background-color: cornflowerblue;
      transition: width 1s ease-out;
    }


    .showgrid {
      display: grid;
    }

    .showflex {
      display: flex;
      flex-direction: column;
    }

    .showflex .file {
      margin-bottom: 1em;
    }

    /* .file.readedFile  */

    .deleteIcon {
      font-weight: bold;
      position: absolute;
      right: 15px;
      top: 5px;
      cursor: pointer;
    }

    .fileIcon {
      position: absolute;
      left: 11px;
      top: 12px;
    }

    .submit {
      /* display: none; */
      justify-self: start;
      align-self: start;
    }

    .submit.show {
      display: initial;
    }

    svg {
      width: 25px;
      height: 25px;
      font-size: 1.7em;
    }
  </style>
</head>

<body>
  <!-- File svg Icon -->
  <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="file-icon-solid" viewBox="0 0 384 512" fill="currentColor" width="1em" height="1em">
      <path
        d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z" />
    </symbol>
  </svg>

  <!-- Close Icon -->
  <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="close-icon-solid" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em">
      <g>
        <path fill="none" d="M0 0h24v24H0z" />
        <path
          d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" />
      </g>
    </symbol>
  </svg>
  <!-- Check Icon -->
  <svg style="display: none" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 48 48">
    <symbol id="check-icon-colored" viewBox="0 0 48 48" width="1em" height="1em">
      <polygon fill="#43A047" points="40.6,12.1 17,35.7 7.4,26.1 4.6,29 17,41.3 43.4,14.9" />
    </symbol>
  </svg>

  <h2>Try to Drop a files</h2>

  <div id="root">

    <div class="dropzone">
      <span>Drag and Drop to Upload</span>
    </div>
    <div class="file-holder"></div>
    <button class="submit">Submit</button>
  </div>

  <script>

    const allowedFileExt = ['png', 'jpg', 'jpeg', 'webp'];
    const fileData = new FormData();

    const root = document.querySelector('#root')
    const dropzone = document.querySelector('.dropzone');
    const fileHolder = document.querySelector('.file-holder');
    const submit = document.querySelector('.submit');

    root.addEventListener('dragover', dragOverRoot);
    root.addEventListener('drop', dropRoot);

    dropzone.addEventListener('drop', dropzoneDrop);
    dropzone.addEventListener('dragenter', dropzoneDragEnter);

    submit.addEventListener('click', submitHandler);

    function renderFileStats(stats, i) {
      // 
      const file = document.createElement('div');
      file.className = 'file'
      file.id = `file${i - 1}`
      // 
      const fileStats = document.createElement('div');
      const filename = document.createElement('div');
      const filesize = document.createElement('div');
      const deleteFile = document.createElement('span');
      const fileIcon = document.createElement('span');

      fileIcon.className = 'fileIcon';
      fileIcon.innerHTML = `<svg><use href="#file-icon-solid" /></svg>`;

      deleteFile.className = 'deleteIcon';
      deleteFile.innerHTML = `<svg><use href="#close-icon-solid" /></svg>`;

      deleteFile.addEventListener('click', deleteFileHandler)

      function deleteFileHandler(e) {
        const element = e.currentTarget.parentElement;
        fileHolder.removeChild(element);
        const key = element.id.toLowerCase();
        fileData.delete(key);
      }

      fileStats.className = 'fileStats';
      filename.className = 'filename';
      filesize.className = 'filesize';
      filename.innerText = stats.name
      filesize.innerHTML = `${(stats.size / 1000).toFixed(2)} KB <span class="checkIcon"><svg><use href="#check-icon-colored" /></svg></span>`;

      const outline = document.createElement('div');
      const inner = document.createElement('div');

      outline.className = 'progressbar-outline'
      inner.className = 'progressbar-inner'
      setTimeout(() => inner.style.width = '100%', 100 * i)

      outline.appendChild(inner)
      fileStats.appendChild(filename)
      fileStats.appendChild(filesize)
      fileStats.appendChild(outline)

      file.appendChild(fileIcon);
      file.appendChild(fileStats);
      fileHolder.appendChild(file)
      setTimeout(() => {
        fileStats.removeChild(outline);
        file.classList.add('readedFile');
        file.appendChild(deleteFile);
      }, (100 * i) * 2 + 1000);
    }

    function appendFormData(param) {
      const files = param
      let counter = 0

      const validFile = new FormData();

      for (let i = 0; i < files.length; i++) {
        const fileName = files[i].name
        const splitName = fileName.split('.');
        const fileExt = splitName[splitName.length - 1].toLowerCase()
        const found = allowedFileExt.find(ext => ext === fileExt);
        if (found) {
          fileData.append(`file${i}`, files[i]);
          validFile.append(`file${i}`, files[i]);
          counter++
        }
      }
      if (counter) {
        fileHolder.classList.add('showflex');
        let i = 1
        for (const file of validFile.values()) {
          renderFileStats(file, i);
          i++
        }
      }
    }

    function dragOverRoot(e) {
      e.preventDefault()
      fileHolder.classList.remove('showflex');
      dropzone.classList.add('showgrid');
      root.style.display = 'grid'
    }

    root.addEventListener('dragleave', dragLeaveRoot);
    function dragLeaveRoot(e) {
      console.log('mouse leave');
      const target = e.target;
      console.log(target)
      // if (target.className !== 'dropzone') {
      //   dropzone.classList.remove('showgrid');
      //   root.style.removeProperty('display');
      // }
    }

    function dropRoot(e) {
      console.log('drop root');
      e.preventDefault();
      dropzone.classList.remove('showgrid');
      root.style.removeProperty('display');
    }

    function dropzoneDrop(e) {
      e.preventDefault();
      console.log('files was dropped');
      dropzone.classList.remove('showgrid');
      root.style.removeProperty('display');
      appendFormData(e.dataTransfer.files)
    }

    function dropzoneDragEnter(e) {
      console.log('dragged on the dropzone')
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add('showgrid');
      root.style.display = 'grid'
    }

    function submitHandler(e) {
      let counter = 0
      for (const file of fileData.keys()) counter++
      if (counter) {
        fetch('/submitter/draganddrop', {
          method: 'post',
          body: fileData
        })
          .then((msg) => console.log(msg))
          .catch((err) => console.log(err))
      } else {
        console.log('no files uploaded');
      }
    }

  </script>

</body>